
---

# Packages

- name: Install keystone service and client
  apt: name="{{ item }}" state=present
  with_items:
    - keystone
    - python-keystoneclient

# Database

- name: Create keystone db
  mysql_db: name="{{ item }}"
            state=present
            login_host="{{ controller_hostname }}"
            login_user=root
            login_password="{{ mysql_root }}"
  with_items:
    - keystone
  notify:
    - Sync keystone db
    - Restart keystone

- name: Create keystone user
  mysql_user: name="{{ item.name }}"
              host="{{ item.host }}"
              password="{{ item.password }}"
              priv="{{ item.privs }}"
              state=present
              login_host="{{ controller_hostname }}"
              login_user=root
              login_password="{{ mysql_root }}"
              append_privs=yes
  with_items:
    - name:     keystone
      host:     localhost
      password: "{{ keystone_dbpass }}"
      privs:    keystone.*:ALL
    - name:     keystone
      host:     "{{ controller_hostname }}"
      password: "{{ keystone_dbpass }}"
      privs:    keystone.*:ALL
  notify:
    - Sync keystone db
    - Restart keystone

# Configuration file

- name: Configure keystone
  ini_file: dest=/etc/keystone/keystone.conf
            section="{{ item.section }}"
            option="{{ item.option }}"
            value="{{ item.value }}"
  with_items:
    - section:  DEFAULT
      option:   admin_token
      value:    "{{ admin_token }}"
    - section:  DEFAULT
      option:   log_dir
      value:    /var/log/keystone
    - section:  database
      option:   connection
      value:    "mysql://keystone:{{ keystone_dbpass }}@{{ controller_hostname }}/keystone"
  notify:
    - Restart keystone

# Security / Maintenance

- name: Make sure keystone is restarted
  meta: flush_handlers

- name: Wait keystone
  wait_for: host="{{ controller_hostname }}" port="{{ keystone_admin_port }}" delay=3

- name: Remove useless SQLite db file
  file: path=/var/lib/keystone/keystone.db state=absent

- name: Add cronjob that remove keystone expired token
  cron: name="remove keystone expired token"
        minute=0
        hour=*/1
        user=keystone
        job="/usr/bin/keystone-manage token_flush >/var/log/keystone/keystone-tokenflush.log 2>&1"
        cron_file="remove-keystone-expired-tokens"

# Tenants, users and roles

- name: "Dump keystone roles"
  shell: keystone role-list
  register: role_list
  changed_when: false
  environment: openstack_service_env

- name: "Dump keystone users"
  shell: keystone user-list
  register: user_list
  changed_when: false
  environment: openstack_service_env

- name: "Dump keystone tenants"
  shell: keystone tenant-list
  register: tenant_list
  changed_when: false
  environment: openstack_service_env

- name: Create the admin tenant
  shell: keystone tenant-create --name admin --description "Admin Tenant"
  environment: openstack_service_env
  when: "tenant_list.stdout.find('admin') == -1"

- name: Create the admin user
  shell: "keystone user-create --name admin --pass {{ admin_pass }} --email admin@localhost"
  environment: openstack_service_env
  when: "user_list.stdout.find('admin') == -1"

- name: Create the admin role
  shell: keystone role-create --name admin
  environment: openstack_service_env
  when: "role_list.stdout.find('admin') == -1"

- name: "Dump admin roles in admin"
  shell: keystone user-role-list --user admin --tenant admin
  register: admin_role_list
  changed_when: false
  environment: openstack_service_env

- name: Add the admin role to admin in the admin tenant
  shell: keystone user-role-add --tenant admin --user admin --role admin
  environment: openstack_service_env
  when: "admin_role_list.stdout.find('admin') == -1"

- name: Create the _member_ role
  shell: keystone role-create --name _member_
  environment: openstack_service_env
  when: "role_list.stdout.find('_member_') == -1"

- name: Add the admin tenant and user to the _member_ role
  shell: keystone user-role-add --tenant admin --user admin --role _member_
  environment: openstack_service_env
  when: "admin_role_list.stdout.find('_member_') == -1"

- name: Create the demo tenant
  shell: keystone tenant-create --name demo --description "Demo Tenant"
  environment: openstack_service_env
  when: "tenant_list.stdout.find('demo') == -1"

- name: Create the demo user
  shell: "keystone user-create --name demo --pass {{ demo_pass }} --email demo@localhost"
  environment: openstack_service_env
  when: "user_list.stdout.find('demo') == -1"

- name: "Dump demo roles in demo"
  shell: keystone user-role-list --user demo --tenant demo
  register: demo_role_list
  changed_when: false
  environment: openstack_service_env

- name: Add the demo tenant and user to the _member_ role
  shell: keystone user-role-add --tenant demo --user demo --role _member_
  environment: openstack_service_env
  when: "demo_role_list.stdout.find('_member_') == -1"

- name: Create the service tenant
  shell: keystone tenant-create --name service --description "Service Tenant"
  environment: openstack_service_env
  when: "tenant_list.stdout.find('service') == -1"

# Endpoints

- name: "Dump service list"
  shell: keystone service-list
  register: service_list
  changed_when: false
  environment: openstack_service_env

- name: "Dump endpoint list"
  shell: keystone endpoint-list
  register: endpoint_list
  changed_when: false
  environment: openstack_service_env

- name: Create the service entity for the identity service
  shell: keystone service-create --name keystone --type identity --description="OpenStack Identity"
  environment: openstack_service_env
  when: "service_list.stdout.find('keystone') == -1"

- name: "Dump identity service id"
  shell: keystone service-list | awk '/ identity / {print $2}'
  register: identity_service_id
  changed_when: false
  environment: openstack_service_env

- name: Create the API endpoint for the Identity service
  shell: >
    keystone endpoint-create \
      --service-id={{ identity_service_id.stdout }} \
      --publicurl=http://{{ controller_hostname }}:{{ keystone_port }}/v2.0 \
      --internalurl=http://{{ controller_hostname }}:{{ keystone_port }}/v2.0 \
      --adminurl=http://{{ controller_hostname }}:{{ keystone_admin_port }}/v2.0
  when: "endpoint_list.stdout.find('{{ identity_service_id.stdout }}') == -1"
  environment: openstack_service_env

